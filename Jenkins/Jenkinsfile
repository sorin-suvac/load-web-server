pipeline {

    agent any

    environment {
        AWS_CREDENTIALS = '/mnt/c/Users/ssuva/.aws/credentials'
        SSH_KEY_FILE = 'aws-ssh-key.pem'
        MASTER_IP = ''
        WORKERS_IPS = ''
    }

    parameters {
        booleanParam(name: 'STAGE_TERRAFORM_APPLY', defaultValue: true, description: 'Enable "Terraform apply" stage')
        booleanParam(name: 'STAGE_INSTALL_K8S', defaultValue: true, description: 'Enable "Install K8S" stage')
        booleanParam(name: 'STAGE_TERRAFORM_DESTROY', defaultValue: true, description: 'Enable "Terraform destroy" stage')
    }

    stages {
        when {
            expression {
                return params.STAGE_TERRAFORM_APPLY
            }
        }
        stage('Terraform apply') {
            steps {
                dir('Terraform') {
                    script {
                        sh 'terraform init -upgrade -no-color'
                        sh 'terraform plan -input=false -var="aws_credentials=${AWS_CREDENTIALS}" -var="ssh_key_file=${SSH_KEY_FILE}" -out my-plan -no-color'
                        sh 'terraform apply -input=false my-plan -no-color'
                        sh 'chmod 400 ${SSH_KEY_FILE}'
                        MASTER_IP = sh(script: 'terraform output -raw master_ip', returnStdout: true)
                        def jsonIPs = sh(script: 'terraform output -json worker_ips', returnStdout: true)
                        def jsonSlurper = new groovy.json.JsonSlurper()
                        WORKERS_IPS = jsonSlurper.parseText(jsonIPs)
                    }
                }
            }
        }
        stage('Install K8S') {
            when {
                expression {
                    return params.STAGE_INSTALL_K8S
                }
            }
            steps {
                dir('Scripts') {
                    script {
                        def sshKey = "../Terraform/${SSH_KEY_FILE}"
                        sh "scp -i ${sshKey} install-kubeadm.sh ubuntu@${MASTER_IP}:/tmp"
                        sh "scp -i ${sshKey} init-kubeadm.sh ubuntu@${MASTER_IP}:/tmp"
                        sh "ssh -i ${sshKey} ubuntu@${MASTER_IP} chmod +x /tmp/*.sh"
                        sh "ssh -i ${sshKey} ubuntu@${MASTER_IP} /tmp/install-kubeadm.sh"
                        sh "ssh -i ${sshKey} ubuntu@${MASTER_IP} /tmp/init-kubeadm.sh"
                        def kubeadmJoinCmd = sh(script: "ssh -i $sshKey ubuntu@${MASTER_IP} kubeadm token create --print-join-command", returnStdout: true)
                        ${WORKERS_IPS}.each { workerIp ->
                            sh "scp -i ${sshKey} install-kubeadm.sh ubuntu@${worker}:/tmp"
                            sh "ssh -i ${sshKey} ubuntu@${workerIp} chmod +x /tmp/install-kubeadm.sh"
                            sh "ssh -i ${sshKey} ubuntu@${workerIp} /tmp/install-kubeadm.sh"
                            sh "ssh -i ${sshKey} ubuntu@${workerIp} sudo ${kubeadmJoinCmd} --v=5"
                        }
                    }
                }
            }
        }
        stage('Terraform destroy') {
            when {
                expression {
                    return params.STAGE_TERRAFORM_DESTROY
                }
            }
            steps {
                dir('Terraform') {
                    sh 'terraform destroy -auto-approve -no-color'
                }
            }
        }
    }
}
